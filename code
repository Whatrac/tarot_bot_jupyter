import logging
import random
import nest_asyncio
from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
import asyncio

# Применяем nest_asyncio для работы asyncio в Jupyter
nest_asyncio.apply()

# Настройка логирования
logging.basicConfig(level=logging.INFO)

# Токен бота
API_TOKEN = '7879796607:AAFVQ1-XdFANRbzh1pQfxQouh8KPLdXMCRw'

# База карт (78 карт: 22 Старших Аркана + 56 Младших Арканов)
TAROT_CARDS = {
    # Старшие Арканы
    "0": {"name": "Дурак", "meaning": "Новые начинания, спонтанность, вера в будущее.", "reversed": "Безрассудство, страх перемен, неосторожность."},
    "1": {"name": "Маг", "meaning": "Проявление, мастерство, использование ресурсов.", "reversed": "Манипуляция, неуверенность, упущенные возможности."},
    "2": {"name": "Верховная Жрица", "meaning": "Интуиция, тайны, внутреннее знание.", "reversed": "Скрытые мотивы, потеря связи с собой."},
    "3": {"name": "Императрица", "meaning": "Плодородие, изобилие, забота.", "reversed": "Зависимость, творческий застой."},
    "4": {"name": "Император", "meaning": "Авторитет, структура, контроль.", "reversed": "Тирания, жесткость, потеря власти."},
    "5": {"name": "Иерофант", "meaning": "Традиции, духовное руководство, обучение.", "reversed": "Бунт, догматизм, ложные убеждения."},
    "6": {"name": "Влюбленные", "meaning": "Любовь, гармония, выбор.", "reversed": "Дисбаланс, конфликт, неверный выбор."},
    "7": {"name": "Колесница", "meaning": "Воля, решимость, победа.", "reversed": "Отсутствие направления, агрессия."},
    "8": {"name": "Сила", "meaning": "Внутренняя сила, терпение, сострадание.", "reversed": "Сомнения, слабость, импульсивность."},
    "9": {"name": "Отшельник", "meaning": "Самоанализ, поиск истины, уединение.", "reversed": "Изоляция, одиночество, потеря пути."},
    "10": {"name": "Колесо Фортуны", "meaning": "Удача, циклы, судьба.", "reversed": "Неудача, сопротивление переменам."},
    "11": {"name": "Справедливость", "meaning": "Правда, равновесие, ответственность.", "reversed": "Несправедливость, уклонение от ответственности."},
    "12": {"name": "Повешенный", "meaning": "Жертва, сдача, новый взгляд.", "reversed": "Застой, ненужная жертва, страх."},
    "13": {"name": "Смерть", "meaning": "Трансформация, окончание, новые начала.", "reversed": "Сопротивление переменам, застой."},
    "14": {"name": "Умеренность", "meaning": "Баланс, терпение, гармония.", "reversed": "Дисбаланс, крайности, нетерпение."},
    "15": {"name": "Дьявол", "meaning": "Искушение, зависимость, материализм.", "reversed": "Освобождение, преодоление пороков."},
    "16": {"name": "Башня", "meaning": "Внезапные перемены, разрушение, откровение.", "reversed": "Страх перемен, избегание кризиса."},
    "17": {"name": "Звезда", "meaning": "Надежда, вдохновение, исцеление.", "reversed": "Отчаяние, потеря веры."},
    "18": {"name": "Луна", "meaning": "Иллюзии, интуиция, подсознание.", "reversed": "Страх, путаница, раскрытие тайн."},
    "19": {"name": "Солнце", "meaning": "Радость, успех, жизненная сила.", "reversed": "Задержки, временное затмение успеха."},
    "20": {"name": "Суд", "meaning": "Возрождение, пробуждение, подведение итогов.", "reversed": "Сомнения, отказ от перемен."},
    "21": {"name": "Мир", "meaning": "Завершение, гармония, исполнение.", "reversed": "Незавершенность, дисгармония."},
    # Младшие Арканы: Жезлы
    "22": {"name": "Туз Жезлов", "meaning": "Вдохновение, новые возможности, энергия.", "reversed": "Задержки, творческий застой."},
    "23": {"name": "Двойка Жезлов", "meaning": "Планирование, выбор пути, амбиции.", "reversed": "Страх решений, нерешительность."},
    "24": {"name": "Тройка Жезлов", "meaning": "Прогресс, расширение, дальновидность.", "reversed": "Препятствия, ограниченные перспективы."},
    "25": {"name": "Четверка Жезлов", "meaning": "Праздник, стабильность, гармония.", "reversed": "Напряжение в доме, нестабильность."},
    "26": {"name": "Пятерка Жезлов", "meaning": "Конкуренция, борьба, конфликт.", "reversed": "Избегание конфликта, гармония."},
    "27": {"name": "Шестерка Жезлов", "meaning": "Победа, признание, успех.", "reversed": "Эгоизм, неудача, задержки."},
    "28": {"name": "Семерка Жезлов", "meaning": "Оборона, стойкость, защита.", "reversed": "Уступка, чувство подавленности."},
    "29": {"name": "Восьмерка Жезлов", "meaning": "Скорость, движение, быстрые события.", "reversed": "Задержки, разочарование."},
    "30": {"name": "Девятка Жезлов", "meaning": "Устойчивость, выносливость, защита.", "reversed": "Паранойя, истощение."},
    "31": {"name": "Десятка Жезлов", "meaning": "Бремя, тяжелая ответственность.", "reversed": "Освобождение, делегирование."},
    "32": {"name": "Паж Жезлов", "meaning": "Энтузиазм, исследование, новые идеи.", "reversed": "Нерешительность, плохие новости."},
    "33": {"name": "Рыцарь Жезлов", "meaning": "Страсть, импульсивность, приключения.", "reversed": "Гнев, импульсивные ошибки."},
    "34": {"name": "Королева Жезлов", "meaning": "Уверенность, харизма, лидерство.", "reversed": "Ревность, эгоизм."},
    "35": {"name": "Король Жезлов", "meaning": "Лидерство, видение, предпринимательство.", "reversed": "Доминирование, импульсивность."},
    # Младшие Арканы: Кубки
    "36": {"name": "Туз Кубков", "meaning": "Любовь, эмоциональное начало, интуиция.", "reversed": "Подавленные эмоции, разочарование."},
    "37": {"name": "Двойка Кубков", "meaning": "Гармония, партнерство, взаимная любовь.", "reversed": "Разрыв, дисбаланс."},
    "38": {"name": "Тройка Кубков", "meaning": "Дружба, праздник, сообщество.", "reversed": "Одиночество, чрезмерность."},
    "39": {"name": "Четверка Кубков", "meaning": "Апатия, переоценка, скука.", "reversed": "Новые возможности, интерес."},
    "40": {"name": "Пятерка Кубков", "meaning": "Сожаление, утрата, печаль.", "reversed": "Прощение, движение вперед."},
    "41": {"name": "Шестерка Кубков", "meaning": "Ностальгия, добрые воспоминания.", "reversed": "Застревание в прошлом."},
    "42": {"name": "Семерка Кубков", "meaning": "Выбор, мечты, иллюзии.", "reversed": "Ясность, реализм."},
    "43": {"name": "Восьмерка Кубков", "meaning": "Уход, поиск смысла, разочарование.", "reversed": "Страх перемен, застой."},
    "44": {"name": "Девятка Кубков", "meaning": "Удовлетворение, исполнение желаний.", "reversed": "Жадность, неудовлетворенность."},
    "45": {"name": "Десятка Кубков", "meaning": "Счастье, гармония в семье.", "reversed": "Разлад, дисгармония."},
    "46": {"name": "Паж Кубков", "meaning": "Чувствительность, творчество, романтика.", "reversed": "Эмоциональная незрелость."},
    "47": {"name": "Рыцарь Кубков", "meaning": "Романтика, идеализм, следование сердцу.", "reversed": "Капризы, разочарование."},
    "48": {"name": "Королева Кубков", "meaning": "Сострадание, интуиция, забота.", "reversed": "Эмоциональная нестабильность."},
    "49": {"name": "Король Кубков", "meaning": "Эмоциональная зрелость, мудрость.", "reversed": "Манипуляция, подавленность."},
    # Младшие Арканы: Мечи
    "50": {"name": "Туз Мечей", "meaning": "Ясность, прорыв, истина.", "reversed": "Путаница, жестокость."},
    "51": {"name": "Двойка Мечей", "meaning": "Нерешительность, баланс, тупик.", "reversed": "Раскрытие, ясность."},
    "52": {"name": "Тройка Мечей", "meaning": "Горе, разбитое сердце, боль.", "reversed": "Исцеление, прощение."},
    "53": {"name": "Четверка Мечей", "meaning": "Отдых, восстановление, размышления.", "reversed": "Выгорание, беспокойство."},
    "54": {"name": "Пятерка Мечей", "meaning": "Конфликт, победа любой ценой.", "reversed": "Примирение, компромисс."},
    "55": {"name": "Шестерка Мечей", "meaning": "Переход, исцеление, движение вперед.", "reversed": "Застой, сопротивление."},
    "56": {"name": "Семерка Мечей", "meaning": "Обман, стратегия, хитрость.", "reversed": "Честность, сожаление."},
    "57": {"name": "Восьмерка Мечей", "meaning": "Ограничения, страх, ловушка.", "reversed": "Освобождение, уверенность."},
    "58": {"name": "Девятка Мечей", "meaning": "Тревога, кошмары, отчаяние.", "reversed": "Надежда, исцеление."},
    "59": {"name": "Десятка Мечей", "meaning": "Предательство, конец, крах.", "reversed": "Восстановление, новый старт."},
    "60": {"name": "Паж Мечей", "meaning": "Любопытство, новые идеи, энергия.", "reversed": "Сплетни, поспешность."},
    "61": {"name": "Рыцарь Мечей", "meaning": "Амбиции, решительность, импульсивность.", "reversed": "Жестокость, хаос."},
    "62": {"name": "Королева Мечей", "meaning": "Ясность, независимость, интеллект.", "reversed": "Жестокость, холодность."},
    "63": {"name": "Король Мечей", "meaning": "Авторитет, истина, дисциплина.", "reversed": "Манипуляция, тирания."},
    # Младшие Арканы: Пентакли
    "64": {"name": "Туз Пентаклей", "meaning": "Процветание, новые возможности, успех.", "reversed": "Упущенные шансы, жадность."},
    "65": {"name": "Двойка Пентаклей", "meaning": "Баланс, адаптация, многозадачность.", "reversed": "Дисбаланс, перегрузка."},
    "66": {"name": "Тройка Пентаклей", "meaning": "Сотрудничество, мастерство, успех.", "reversed": "Разногласия, посредственность."},
    "67": {"name": "Четверка Пентаклей", "meaning": "Стабильность, контроль, жадность.", "reversed": "Щедрость, освобождение."},
    "68": {"name": "Пятерка Пентаклей", "meaning": "Нищета, потери, отчаяние.", "reversed": "Восстановление, надежда."},
    "69": {"name": "Шестерка Пентаклей", "meaning": "Щедрость, баланс, помощь.", "reversed": "Эгоизм, долги."},
    "70": {"name": "Семерка Пентаклей", "meaning": "Терпение, инвестиции, рост.", "reversed": "Нетерпение, неудачи."},
    "71": {"name": "Восьмерка Пентаклей", "meaning": "Мастерство, труд, обучение.", "reversed": "Лень, низкое качество."},
    "72": {"name": "Девятка Пентаклей", "meaning": "Роскошь, независимость, изобилие.", "reversed": "Финансовая зависимость, одиночество."},
    "73": {"name": "Десятка Пентаклей", "meaning": "Богатство, наследие, стабильность.", "reversed": "Финансовые потери, разлад."},
    "74": {"name": "Паж Пентаклей", "meaning": "Амбиции, новые возможности, учеба.", "reversed": "Лень, нереалистичность."},
    "75": {"name": "Рыцарь Пентаклей", "meaning": "Надежность, трудолюбие, методичность.", "reversed": "Застой, лень."},
    "76": {"name": "Королева Пентаклей", "meaning": "Забота, процветание, практичность.", "reversed": "Финансовая нестабильность, эгоизм."},
    "77": {"name": "Король Пентаклей", "meaning": "Богатство, лидерство, стабильность.", "reversed": "Жадность, упрямство."}
}

# Инициализация бота и диспетчера
bot = Bot(token=API_TOKEN)
dp = Dispatcher()

# Клавиатура для выбора расклада
def get_layout_keyboard():
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="Карта дня", callback_data="daily")],
        [InlineKeyboardButton(text="Прогноз на месяц", callback_data="monthly")]
    ])
    return keyboard

# Обработчик команды /start
@dp.message(Command("start"))
async def send_welcome(message: types.Message):
    await message.reply(
        "Привет! Я бот для раскладов Таро на основе колоды из 78 карт. Выбери расклад:",
        reply_markup=get_layout_keyboard()
    )

# Обработчик выбора расклада
@dp.callback_query()
async def process_layout(callback: types.CallbackQuery):
    try:
        if callback.data == "daily":
            # Карта дня: 1 случайная карта
            card_id = random.choice(list(TAROT_CARDS.keys()))
            card = TAROT_CARDS[card_id]
            is_reversed = random.choice([True, False])
            meaning = card["reversed"] if is_reversed else card["meaning"]
            response = (
                f"**Карта дня**: {card['name']}\n"
                f"**Положение**: {'Перевернутое' if is_reversed else 'Прямое'}\n"
                f"**Значение**: {meaning}"
            )
            await callback.message.answer(response)
        elif callback.data == "monthly":
            # Прогноз на месяц: 3 карты
            cards = random.sample(list(TAROT_CARDS.keys()), 3)
            response = "**Прогноз на месяц**:\n\n"
            positions = ["Прошлое", "Настоящее", "Будущее"]
            for i, card_id in enumerate(cards):
                card = TAROT_CARDS[card_id]
                is_reversed = random.choice([True, False])
                meaning = card["reversed"] if is_reversed else card["meaning"]
                response += (
                    f"**{positions[i]}**: {card['name']}\n"
                    f"**Положение**: {'Перевернутое' if is_reversed else 'Прямое'}\n"
                    f"**Значение**: {meaning}\n\n"
                )
            await callback.message.answer(response)
        await callback.answer()
    except Exception as e:
        logging.error(f"Ошибка при обработке расклада: {e}")
        await callback.message.answer("Произошла ошибка. Попробуйте еще раз.")
        await callback.answer()

# Функция для запуска бота
async def main():
    try:
        await dp.start_polling(bot)
    except Exception as e:
        logging.error(f"Ошибка при запуске бота: {e}")

# Запуск бота в Jupyter
loop = asyncio.get_event_loop()
loop.create_task(main())
